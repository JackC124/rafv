<!DOCTYPE html>
<html>
<head>
  <title>QRA Controller | IVAO Live</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body{margin:0;font-family:"Courier New",monospace;}
    #map{height:100vh;}
    .title{position:absolute;top:10px;left:50%;transform:translateX(-50%);
      background:rgba(0,0,0,0.7);color:#0f0;padding:6px 12px;border-radius:6px;
      font-weight:bold;z-index:1000;box-shadow:0 0 10px #0f0;}
    #qraPanel{position:absolute;top:60px;left:10px;background:#111;color:#0f0;padding:10px;
      border:1px solid #0f0;border-radius:6px;max-height:500px;overflow-y:auto;z-index:1000;}
    #qraPanel button,input{display:block;margin:4px 0;width:100%;padding:6px;background:#000;color:#0f0;
      border:1px solid #0f0;border-radius:4px;cursor:pointer;}
    #qraPanel button:hover,input:hover{background:#0f0;color:#000;}
    .interceptHeading{color:yellow;font-weight:bold;font-size:12px;margin-bottom:4px;}
  </style>
</head>
<body>

<div class="title">üõ°Ô∏è QRA Controller Map | IVAO Live</div>
<div id="map"></div>

<div id="qraPanel">
  <h3>Online QRA Jets</h3>
  <input type="text" id="targetInput" placeholder="Hostile Callsign">
  <button id="setTargetBtn">Set Hostile Target</button>
  <button id="resetHostileBtn">Reset Hostile</button>
  <div id="qraList"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-rotatedmarker/leaflet.rotatedMarker.js"></script>

<script>
const map = L.map('map').setView([20,0],3);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
  attribution:'&copy; CartoDB, OpenStreetMap',subdomains:'abcd',maxZoom:19
}).addTo(map);

let markers = {};
let selectedFlightPath = null;
let hostileCallsign = null;
let interceptLines = {};

function getAircraftIcon(ac, isHostile=false, isJet=false){
  const rotation = (ac.heading||0)-90;
  let color='lime';
  if(isHostile) color='red';
  else if(isJet) color='blue';
  return L.divIcon({
    html:`<div style="transform:rotate(${rotation}deg);
      font-size:20px;color:${color};text-shadow:0 0 2px black;line-height:20px;text-align:center;
      background:transparent;border:none;padding:0;margin:0;">‚úà</div>`,
    className:'',
    iconSize:[20,20],
    iconAnchor:[10,10]
  });
}

function calculateBearing(lat1, lon1, lat2, lon2){
  const œÜ1 = lat1 * Math.PI/180;
  const œÜ2 = lat2 * Math.PI/180;
  const ŒîŒª = (lon2 - lon1) * Math.PI/180;
  const y = Math.sin(ŒîŒª)*Math.cos(œÜ2);
  const x = Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
  let Œ∏ = Math.atan2(y, x)*180/Math.PI;
  return (Œ∏+360)%360;
}

// Fetch aircraft and update map
async function fetchAircraft(){
  try{
    const res = await fetch("/api/aircraft");
    const aircraft = await res.json();
    const active = [];
    const jets = JSON.parse(localStorage.getItem("onlineJets")||"{}");

    aircraft.forEach(ac=>{
      if(!ac.lat||!ac.lon) return;
      active.push(ac.callsign);
      const isHostile = (ac.callsign === hostileCallsign);
      const isJet = jets.hasOwnProperty(ac.callsign);

      if(markers[ac.callsign]){
        markers[ac.callsign].setLatLng([ac.lat, ac.lon]);
        markers[ac.callsign].setIcon(getAircraftIcon(ac,isHostile,isJet));
      } else {
        const marker = L.marker([ac.lat, ac.lon], {icon:getAircraftIcon(ac,isHostile,isJet)}).addTo(map);
        marker.bindTooltip(`
          <div style="background:#111;color:#0f0;font-family:'Courier New';padding:4px;border-radius:4px;line-height:1.2;">
            <div><b>${ac.callsign}</b> | ${ac.departure} ‚Üí ${ac.arrival}</div>
            <div>Alt: ${ac.altitude || 0} ft | Spd: ${ac.speed || 0} kt</div>
            <div>Aircraft: ${ac.aircraft || "N/A"} | XPDR: ${ac.transponder || "N/A"} (${ac.transponderMode || "N/A"})</div>
            <div style="font-style:italic;font-size:12px;">Click marker to show flight path</div>
          </div>`, {permanent:false,direction:'top',className:''});
        marker.on('click', async ()=>{
          if(selectedFlightPath) map.removeLayer(selectedFlightPath);
          const pathRes = await fetch("/api/flightpaths");
          const positions = (await pathRes.json())[ac.callsign]||[];
          if(positions.length>0){
            const latlngs = positions.map(p=>[p.lat,p.lon]);
            selectedFlightPath = L.polyline(latlngs,{color:'lime',weight:3,opacity:0.8,dashArray:'5,5'}).addTo(map);
          }
          marker.openTooltip();
        });
        markers[ac.callsign] = marker;
      }
    });

    // Remove old markers
    Object.keys(markers).forEach(c=>{
      if(!active.includes(c)){
        map.removeLayer(markers[c]);
        delete markers[c];
      }
    });

    // Intercept lines & per-jet heading
    Object.values(jets).forEach(jet=>{
      if(interceptLines[jet.callsign]) map.removeLayer(interceptLines[jet.callsign]);
      delete interceptLines[jet.callsign];
      if(jet.status==='Scrambled' && hostileCallsign && markers[jet.callsign] && markers[hostileCallsign]){
        const from = markers[jet.callsign].getLatLng();
        const to = markers[hostileCallsign].getLatLng();
        interceptLines[jet.callsign] = L.polyline([from,to],{color:'red',weight:2,opacity:0.9,dashArray:'5,5'}).addTo(map);
        jet.interceptHeading = Math.round(calculateBearing(from.lat, from.lng, to.lat, to.lng))+"¬∞";
      } else {
        jet.interceptHeading = "N/A";
      }
    });

    localStorage.setItem("onlineJets", JSON.stringify(jets));
    renderQRAList();

  }catch(err){ console.error(err); }
}

map.on('click', ()=>{
  if(selectedFlightPath) map.removeLayer(selectedFlightPath);
  selectedFlightPath = null;
  Object.values(markers).forEach(m=>m.closeTooltip());
});

fetchAircraft();
setInterval(fetchAircraft,15000);

// QRA Panel
function renderQRAList(){
  const qraListDiv = document.getElementById("qraList");
  qraListDiv.innerHTML = "";
  const jets = JSON.parse(localStorage.getItem("onlineJets")||"{}");

  Object.values(jets).forEach(jet=>{
    const div = document.createElement("div");
    div.innerHTML = `<b>${jet.callsign}</b> (${jet.aircraft}) - Status: ${jet.status}`;
    const headingDiv = document.createElement("div");
    headingDiv.className="interceptHeading";
    headingDiv.textContent = "Heading: "+(jet.interceptHeading||"N/A");

    const scrambleBtn = document.createElement("button");
    scrambleBtn.textContent = "Scramble";
    scrambleBtn.onclick = ()=>{
      if(!hostileCallsign){ alert("Set a hostile target first!"); return; }
      jet.status="Scrambled";
      localStorage.setItem("onlineJets", JSON.stringify(jets));
      fetchAircraft();
    };

    const removeBtn = document.createElement("button");
    removeBtn.textContent = "Remove Jet";
    removeBtn.onclick = ()=>{
      // Remove intercept line if exists
      if(interceptLines[jet.callsign]){ map.removeLayer(interceptLines[jet.callsign]); delete interceptLines[jet.callsign]; }
      // Remove from local storage
      delete jets[jet.callsign];
      localStorage.setItem("onlineJets", JSON.stringify(jets));
      fetchAircraft();
    };

    div.appendChild(headingDiv);
    qraListDiv.appendChild(div);
    qraListDiv.appendChild(scrambleBtn);
    qraListDiv.appendChild(removeBtn);
  });
}

// Hostile target
document.getElementById("setTargetBtn").addEventListener("click", ()=>{
  const targetCallsign = document.getElementById("targetInput").value.trim();
  if(!targetCallsign){ alert("Enter a hostile callsign"); return; }
  if(!markers[targetCallsign]){ alert("No such aircraft on IVAO!"); return; }
  hostileCallsign = targetCallsign;
  fetchAircraft();
});

// Reset hostile
document.getElementById("resetHostileBtn").addEventListener("click", ()=>{
  hostileCallsign=null;
  Object.values(interceptLines).forEach(l=>map.removeLayer(l));
  interceptLines={};
  const jets = JSON.parse(localStorage.getItem("onlineJets")||"{}");
  Object.values(jets).forEach(j=>j.interceptHeading="N/A");
  localStorage.setItem("onlineJets", JSON.stringify(jets));
  fetchAircraft();
});
</script>
</body>
</html>
